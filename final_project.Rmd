---
title: "Salmon and Protected Areas"
author: "Adelaide Robinson"
date: "2022-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
```

# Background

# Data Wrangling: All Species

## Reading In Data

I used data from two sources: California Department of fish and wildlife and California Protected areas database.

```{r}
salmon_populations <- read_csv(here("data/Salmonid_Population_Monitoring_Data_CMPv2021.csv"))


watershed <- st_read("data/ds3001/ds3001.gdb")


protected_areas <- st_read("data/CPAD_2022a/CPAD_2022a_Holdings.dbf")

```

## Filtering to Adult Salmon Data

In this section I refine the data, for this study I am interested in looking at adult population counts, so I select data on Adults.

Not every watershed polygon has count data for it. I am taking out polygons with no adult data associated. There are 157 polygons of watersheds, I have adult counts for 110 of them.

```{r}

spawning_data <- salmon_populations |> filter(`Life Stage` %in% "Adult") |> #all adult salmon
  select("Population", "Watershed", "Species", Brood_year = "Brood Year", "GEO_ID_POLY", "Value") |> filter(!is.na(GEO_ID_POLY)) #taking out data with no spatial id


watershed_id <- unique(spawning_data$GEO_ID_POLY) #making a list of all the watersheds that have adult population data 

watershed_new <- watershed |> filter(GEO_ID_POL %in% watershed_id)#filter to watersheds that have spawning data available


protected <- protected_areas |> select(UNIT_NAME, YR_EST) |> st_make_valid()
#selecting relevant columns

```

## Filtering Protected Areas

```{r}
protected2 <- protected |> filter(YR_EST < 2009| YR_EST %in% c(NA)) #remove after 2009


```

## Calculating Percent Protected: Geo spatial Wrangling

```{r}
intersect_polygons <- st_intersection(protected2, watershed) %>% 
   mutate(intersect_area = st_area(.)) %>%  # create new column with shape area
   dplyr::select(Name, GEO_ID_POL, intersect_area) #select columns
 
#find total protected area by watershed
total_overlap <- intersect_polygons |> group_by(Name) |> summarize(n())|> 
  mutate(total_protected = st_area(geometry)) 

```

### Mapping

```{r}

tmap_mode("view")

tmap_options(check.and.fix = TRUE)

tm_shape(total_overlap) + tm_fill(col = "green") + #map protected portions
  tm_shape(watershed_new) + tm_borders(col = "blue") #map watershed boundaries

```

```{r}
# dropping geometry 
total_overlap_2 <- total_overlap |> st_drop_geometry()

watershed_area <- watershed_new |> mutate(total_area = st_area(Shape)) #find the total area of each watershed 

watershed_protected <- left_join(watershed_area, total_overlap_2, by = "Name") #add area protected column by joining

watershed_final <- watershed_protected |> mutate(percent_protected = as.numeric((total_protected)/ as.numeric(total_area)) *100) |> 
  mutate(percent_protected = round(percent_protected, digits = 0)) |> 
  mutate(percent_protected  = replace_na(percent_protected, 0))

#drop geometry and make it a data frame
watershed_geomless <- st_drop_geometry(watershed_final) |> as.data.frame() 

#all spawning observations with percent protected included 
all_data <- left_join(spawning_data, watershed_geomless, by = c("GEO_ID_POLY" = "GEO_ID_POL"))

```

# Steelhead

## Data Wrangling

```{r}
steelhead <- all_data |> filter(Species == "Steelhead")


steelhead2 <- steelhead |>  group_by(Population, Brood_year) |> summarize(Value = max(Value), percent_protected = mean(percent_protected)) #taking the max estimation for years where estimate done in multiple ways 


data_years <- steelhead2 |> group_by(Population) |> summarize(min_year = min(Brood_year), max_year = max(Brood_year), total_year = length(Brood_year)) #find what years I have data over

use_list <- data_years |> filter(min_year <= 2009) |> filter(max_year >= 2018)


list <- use_list$Population


steelhead_usable <- steelhead2 |> filter(Population %in% list) |> filter(Brood_year >= 2009) |> filter(Brood_year <= 2018)

#remove any populations which are zero over this whole time period
steelhead12 <- steelhead_usable |> group_by(Population) |> summarize(max = max(Value)) |> filter(max == 0)
remove <- steelhead12$Population


steelhead_usable <- steelhead_usable |> filter(!Population %in% remove)

remove_list <- steelhead_usable |> group_by(Population) |> summarize(min_year = min(Brood_year), max_year = max(Brood_year), total_year = length(Brood_year)) |> 
  filter(max_year != 2018 | min_year != 2009)

remove <- remove_list$Population


steelhead_usable <- steelhead_usable |> filter(!Population %in% remove)


 
 

```

# 

## Regression

$population = B_0 + B_1year_t + B_2Year_t * Protected +E_i$

```{r}
steelhead_new <- steelhead_usable |>  mutate(year = as.numeric(Brood_year))

summary(lm(Value~year + year:percent_protected, data = steelhead_new))


#running a regression with all the steelhead data
steelhead_all <- all_data |> filter(Species == "Steelhead") |> mutate(year = as.numeric(Brood_year))

summary(lm(Value~year + year:percent_protected, data = steelhead_all))


```

## Assumptions of OLS

### Linear in Parameters

It's very difficult to tell if its linear in parameters

```{r}
ggplot(data = steelhead_new, aes(x = year, y = Value)) + geom_point() + geom_smooth(method=lm, se = FALSE)



```

### X has variation

**This is true**

### Assumption 4

These do not appear to be normally distributed.

```{r}
model <- lm(Value~year + year:percent_protected, data = steelhead_new)
residuals <- model$residuals |> as.data.frame()


ggplot(data = residuals) + geom_histogram(aes(x = model$residuals))
```

# Coho

```{r}

coho <- all_data |> filter(Species == "Coho salmon")

coho2 <- coho |>  group_by(Population, Brood_year) |> summarize(Value = max(Value), percent_protected = max(percent_protected)) #taking the max estimation for years where estimate done in multiple ways 


data_years <- coho2 |> group_by(Population) |> summarize(min_year = min(Brood_year), max_year = max(Brood_year), total_year = length(Brood_year)) #find what years I have data over

use_list <- data_years |> filter(min_year <= 2009) |> filter(max_year >= 2018)

list <- use_list$Population


coho_usable <- coho2 |> filter(Population %in% list) |> filter(Brood_year >= 2009) |> filter(Brood_year <= 2018)

#remove any populations which are zero over this whole time period
coho12 <- coho_usable |> group_by(Population) |> summarize(max = max(Value)) |> filter(max == 0)
remove <- coho12$Population


coho_usable2 <- coho_usable |> filter(!Population %in% remove)

remove_list <- coho_usable |> group_by(Population) |> summarize(min_year = min(Brood_year), max_year = max(Brood_year), total_year = length(Brood_year)) |> 
  filter(max_year != 2018 | min_year != 2009)

remove <- remove_list$Population


coho_final <- coho_usable |> filter(!Population %in% remove)

ggplot(data = coho_final) + geom_point(aes(x = Brood_year, y = Value))





```

```{r}
coho_final <- coho_final |>  mutate(year = as.numeric(Brood_year))

summary(lm(Value~year + year:percent_protected, data = coho_final))


```

```{r}
acf(coho_final$Value, lag.max = 10)



```

# 

# Limitations and Issues

There were a lot of NA s in the year protected roughly 32 % of the polygons I used The definition of protected area was very loose. The data was not consistent over time, so I only used data from 2008-2018. Some watersheds within the study have hatchery releases which are not consistent over time, this can wildly affect the population from year to year.
