---
title: "Salmon and Protected Areas"
author: "Adelaide Robinson"
format: 
  revealjs:
    theme: sky
    scrollable: true
editor: visual
execute: 
  echo: false
  warning: false
  message: false
  output: false
---

## Background and Motivation {.smaller}

-   Many populations of anadromous salmon are expected to go extinct within the next 100 years

    -   Anadromous fish are born in freshwater, migrate to ocean and return to freshwater to reproduce
    -   Most steelhead and all coho populations within California Are Federally listed

-   Habitat loss and urban land use are linked with their decline and lowered juvenile survival

![](photos/20200306_105311.jpg){fig-align="center" width="565"}

## Question

How do protected areas impact salmon populations within California?

![](photos/20180131_110346.jpg){fig-align="center" width="487"}

## Data {.smaller}

-   California Monitoring Plan for Salmon and Steelhead

    -   CDFW and NOAA

    -   Monitor and Assemble data on anadromous salmon populations across CA

        -   Adult population counts

        -   Geospatial data containing the extents of monitored watersheds

-   California Protected Area Database

    -   Polygons of areas protected for open space across CA

## Data Wrangling

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
library(kableExtra)
library(broom)

salmon_populations <- read_csv(here("data/Salmonid_Population_Monitoring_Data_CMPv2021.csv"))

watershed <- st_read(here("data/ds3001/ds3001.gdb"))

protected_areas <- st_read(here("data/CPAD_2022a/CPAD_2022a_Holdings.dbf"))

spawning_data <- salmon_populations |> filter(`Life Stage` %in% "Adult") |> #all adult salmon
  select("Population", "Watershed", "Species", Brood_year = "Brood Year", "GEO_ID_POLY", "Value", "Metric", "Estimation method") |> #selecting relevant columns
  filter(!is.na(GEO_ID_POLY)) #taking out data with no matching spatial id

watershed_id <- unique(spawning_data$GEO_ID_POLY) #making a list of all the watersheds that have adult population data 

watershed_new <- watershed |> filter(GEO_ID_POL %in% watershed_id) |> st_make_valid() |> 
  mutate(centroid = st_centroid(Shape))#filter to watersheds that have spawning data available

protected <- protected_areas |> select(UNIT_NAME,YR_EST) |> st_make_valid()
#selecting relevant columns

protected2 <- protected |> filter(YR_EST < 1981| YR_EST %in% c(NA)) #remove after 1981

intersect_polygons <- st_intersection(protected2,watershed_new) |> 
   dplyr::select(Name, GEO_ID_POL) #select relevant columns
 
#find total area protected for each watershed 
total_overlap <- intersect_polygons |> group_by(Name) |> #group by watershed
  summarize(geometry = st_union(geometry))|> #combine geometries within watershed
  mutate(total_protected = st_area(geometry)) #find total protected 

# dropping geometry 
total_overlap_geomless <- total_overlap |> st_drop_geometry()

watershed_area <- watershed_new |> mutate(total_area = st_area(Shape)) #find the total area of each watershed 

watershed_protected <- left_join(watershed_area, total_overlap_geomless, by = "Name") #add area protected column by joining

#calculate percent protected 
watershed_final <- watershed_protected |> 
mutate(percent_protected = 
         as.numeric((total_protected)/ as.numeric(total_area)) *100) |> 
  mutate(percent_protected = round(percent_protected, digits = 0)) |> #round 
  mutate(percent_protected  = replace_na(percent_protected, 0)) #change NA to 0

#drop geometry and make it a data frame
watershed_geomless <- st_drop_geometry(watershed_final) |> as.data.frame() |> 
  select(- Method_Typ)

#combine spawning observations with percent protected
all_data <- left_join(spawning_data, watershed_geomless, by = c("GEO_ID_POLY" = "GEO_ID_POL")) |> select("Population", "Species", "Value", "percent_protected", "Name", "Brood_year", "Metric", "Estimation method", "GEO_ID_POLY")


```

```{r}
#| output: true
tmap_mode("view")

tmap_options(check.and.fix = TRUE)

area_protected <- tm_shape(total_overlap) + tm_fill(col = "#004600") + #map protected portions
  tm_shape(watershed_new) + tm_borders(col = "blue") + tm_add_legend(labels = c( "Watershed Boundary", "Protected area"), col = c("blue", "#004600")) #map watershed boundaries


percent_protected <- tm_shape(watershed_final) + tm_polygons(col = "percent_protected")

tmap_arrange(area_protected,percent_protected)
```

## Analysis {.smaller}

$population = B_0 + B_1year_i + B_2PercentProtected_i + B_3year_i * percentprotected_i +E_i$

-   OLS Linear Regression

    -   Multiple Regression: Population regressed on percent protected and year
    -   Interaction: Percent protected and year
        -   The slope of the relationship between year and population count can vary based on %protected.

-   $H_0: B_1 = B_2 = B_3 = 0$

-   $H_A: B_1 ≠B_2 ≠B_3 ≠ 0$

-   Ran analysis for Both coho salmon and steelhead

## Results {.smaller}

```{r}
steelhead <- all_data |> filter(Species == "Steelhead") #filter for steelhead

steelhead_consistent <- steelhead |> group_by(Population) |> summarize(percent_protected = max(percent_protected)) #making value of percent protected consistent across the population

steelhead_summary <- steelhead |>  group_by(Population, Brood_year) |> summarize(Value = round(mean(Value),0)) #taking average where population count calculated in more than one way

steelhead_final <- left_join(steelhead_summary, steelhead_consistent, by = "Population")
        
No_fish <- steelhead_final |> group_by(Population) |> summarize(max = max(Value)) |> filter(max > 0)

Keep <- No_fish$Population

steelhead <- steelhead_final |>  filter(Population %in% Keep)
                                                                         
#making the first year 0, as I only want to understand population change over the time period I have data for 
steelhead_all <- steelhead |> mutate(year = as.numeric(Brood_year) -1981)

```

```{r}

model <- lm(Value~percent_protected + year + year:percent_protected, data = steelhead_all)

```

```{r}
#| output: true
tidy(model, conf.int = TRUE) |> kable()

```

## Interpretation {.smaller}

-   Watersheds with higher numbers of percent protected have higher numbers of fish

    -   when year is 0 there will be on average 14 more steelhead for each one unit increase in percent protected

-   Increase in percent protected decreases the rate of change in populations over time

    -   -0.5 is the difference in the effect of year on steelhead count for every one increase in protected area

-   Steelhead are increasing over time

    -   when percent protected is 0 on average there will be an increase of 35 fish per year

-   Coefficients are statistically significant using a significance level of 0.05, except the intercept.

## Limitations and OLS Violations

-   True population likely not linear in parameters

-   Is there omitted variable bias?

-   Error is not normally distributed or independent

::: columns
::: {.column width="50%"}
```{r}
#| output: true
residuals <- model$residuals |> as.data.frame()

ggplot(data = residuals) + geom_histogram(aes(x = model$residuals)) + labs(x = "residuals", title = "Model Errors")
```
:::

::: {.column width="50%"}
```{r}
#| output: true
ggplot(data = steelhead_all, aes(x = year, y = Value)) + geom_point() +labs( x = "Year", y = "Population Count")

```
:::
:::

## Lessons and Next Steps

-   Although my results were significant, I fail to reject the null due to concerns over OLS violations

    -   Other methods besides OLS may be better for answering my question

-   Explore the relationship between protected areas and survival in a different way

    -   Would be better to look at overwinter survival rate
