---
title: "Salmon and Protected Areas"
author: "Adelaide Robinson"
format: revealjs
editor: visual
execute: 
  echo: false
  warning: false
  message: false
  output: false
---

## Background and Motivation

-   Many populations of anadromous salmon are expected to go extinct within the next 100 years
    -   5 out of seven steelhead DPS (Distinct Population Segments) in California are federally listed
    -   Both ESU (evolutionary significant units) of coho are listed
-   While numerous factors affect their decline habitat loss is a major factor
-   Urban land use has been linked to the decline over time and shown to impact juvenile survival in the Pacific Northwest

## Question

How do protected areas impact salmon populations within California?

## Data

-   California Monitoring Plan for Salmon and Steelhead

    -   CDFW and NOAA

    -   Monitor and Assemble data on anadromous salmon populations across CA

        -   population counts for watersheds across California

        -   Geospatial data containing the extents of monitored watersheds

-   California Protected Area Database

    -   polygons of areas protected for open space across Ca

# Protected Area Visualization

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
library(kableExtra)
library(lfe)
library(broom)
salmon_populations <- read_csv(here("data/Salmonid_Population_Monitoring_Data_CMPv2021.csv"))

watershed <- st_read(here("data/ds3001/ds3001.gdb"))

protected_areas <- st_read(here("data/CPAD_2022a/CPAD_2022a_Holdings.dbf"))

spawning_data <- salmon_populations |> filter(`Life Stage` %in% "Adult") |> #all adult salmon
  select("Population", "Watershed", "Species", Brood_year = "Brood Year", "GEO_ID_POLY", "Value", "Metric", "Estimation method") |> #selecting relevant columns
  filter(!is.na(GEO_ID_POLY)) #taking out data with no matching spatial id

watershed_id <- unique(spawning_data$GEO_ID_POLY) #making a list of all the watersheds that have adult population data 

watershed_new <- watershed |> filter(GEO_ID_POL %in% watershed_id) |> st_make_valid() |> 
  mutate(centroid = st_centroid(Shape))#filter to watersheds that have spawning data available

protected <- protected_areas |> select(UNIT_NAME,YR_EST) |> st_make_valid()
#selecting relevant columns

protected2 <- protected |> filter(YR_EST < 1981| YR_EST %in% c(NA)) #remove after 1981

intersect_polygons <- st_intersection(protected2,watershed_new) |> 
   dplyr::select(Name, GEO_ID_POL) #select relevant columns
 
#find total area protected for each watershed 
total_overlap <- intersect_polygons |> group_by(Name) |> #group by watershed
  summarize(geometry = st_union(geometry))|> #combine geometries within watershed
  mutate(total_protected = st_area(geometry)) #find total protected 

# dropping geometry 
total_overlap_geomless <- total_overlap |> st_drop_geometry()

watershed_area <- watershed_new |> mutate(total_area = st_area(Shape)) #find the total area of each watershed 

watershed_protected <- left_join(watershed_area, total_overlap_geomless, by = "Name") #add area protected column by joining

#calculate percent protected 
watershed_final <- watershed_protected |> 
mutate(percent_protected = 
         as.numeric((total_protected)/ as.numeric(total_area)) *100) |> 
  mutate(percent_protected = round(percent_protected, digits = 0)) |> #round 
  mutate(percent_protected  = replace_na(percent_protected, 0)) #change NA to 0

#drop geometry and make it a data frame
watershed_geomless <- st_drop_geometry(watershed_final) |> as.data.frame() |> 
  select(- Method_Typ)

#combine spawning observations with percent protected
all_data <- left_join(spawning_data, watershed_geomless, by = c("GEO_ID_POLY" = "GEO_ID_POL")) |> select("Population", "Species", "Value", "percent_protected", "Name", "Brood_year", "Metric", "Estimation method", "GEO_ID_POLY")


```

```{r}
#| output: true
tmap_mode("view")

tmap_options(check.and.fix = TRUE)

area_protected <- tm_shape(total_overlap) + tm_fill(col = "#004600") + #map protected portions
  tm_shape(watershed_new) + tm_borders(col = "blue") + tm_add_legend(labels = c( "Watershed Boundary", "Protected area"), col = c("blue", "#004600")) #map watershed boundaries


percent_protected <- tm_shape(watershed_final) + tm_polygons(col = "percent_protected")

tmap_arrange(area_protected,percent_protected)
```

## Analysis

$populationcount = B_0 + B_1year_t + + B_2percentprotected + B_3Year_t * percentProtected +E_i$

-   Used OLS Linear Regression

-   Used linear model with multiple group fixed affects

    -   helps account for difference between populations and inconsistent collection at sites over all years

    -   sweeps away variation between populations

    -   I also used clustered standard error-accounts for the fact that error within populations will be correlated (violating heteroskedacticity)

## Results

```{r}
steelhead <- all_data |> filter(Species == "Steelhead") #filter for steelhead


steelhead_summary <- steelhead |>  group_by(Population, Brood_year) |> summarize(Value = max(Value), percent_protected = round(mean(percent_protected))) #taking the mean estimation for years where estimate done multiple ways 


data_years <- steelhead_summary |> group_by(Population) |> summarize(min_year = min(Brood_year), max_year = max(Brood_year), total_year = length(Brood_year)) #find what years I have data over

#making the first year 0, as I only want to understand population change over the time period I have data for 

steelhead_all <- steelhead_summary |> mutate(year = as.numeric(Brood_year) -1981)


```

```{r}

model <- felm(Value~year + percent_protected + year:percent_protected | Population | 0 | Population , data = steelhead_all)

summary(model)

percent_protected <- confint.lm(model, 'percent_protected', level = 0.95)

percent_protected

interaction <- confint(model, 'year:percent_protected', level = 0.95)

year <- confint(model, 'year', level = 0.95)



```

```{r}
#| output: true

tidy(model, conf.int = TRUE, conf.level = 0.95) |> kable()

```
- Interpretation
    - Percent protected has a statistically insignificant affect on the number of fish. 
    - It appears that percent protected decreases the rate of change in populations over time 
        - -0.5 is the difference in the effect of year on fish count for every one increase in protected area 
    - Year has a positive affect on the number of steelhead
      - when %protected is 0 on average there will be an increase of 33 fish per year
- Limitations
   - Not convinced my data is linear in parameters
   - Is there omitted variable bias?
   - Using a loose definition of protected
- What's Next?
  - Would be better to look at overwinter survival rates
  - Explore the relationship between protected areas and survival in a different way 
   
